?<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Clientes</title>

    
    <link rel="icon" href="{{ url_for('static', filename='img/aviao.png') }}" type="image/png">

    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-main.css') }}" />

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
      .main-content-card { background:#fff; border-radius:12px; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
      .custom-modal-header { background: #0d6efd; }
      .required-star { color:#dc3545; margin-left:4px; }
      .table-skeleton td{height:42px;background:linear-gradient(90deg,#f2f2f2 25%,#e9ecef 37%,#f2f2f2 63%);background-size:400% 100%;animation: shimmer 1.4s ease infinite;}
      @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }
      .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
      .readonly-like { background-color:#f8f9fa; }
      .spinner-inline { display:inline-flex; align-items:center; gap:.5rem; }
      .spinner-inline .spinner-border{ width:1rem; height:1rem; border-width:.15rem; }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg custom-navbar shadow-sm">
      <div class="container-fluid">
        <span class="navbar-brand fw-bold text-white">Sistema de Clientes</span>
        <div class="ms-auto d-flex align-items-center">
          <span class="custom-header me-2">
            <span>Remoção Área</span>
            <i class="fas fa-plane header-icon"></i>
          </span>  <button id="helpBtn" class="btn btn-outline-light me-2" aria-label="Ajuda da ferramenta" title="Ajuda"><i class="fas fa-circle-exclamation"></i></button>  <button id="logoutBtn" class="btn btn-outline-light ms-3" aria-label="Sair do sistema">Sair</button>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <div class="main-content-card">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
          <h4 class="m-0">Clientes Cadastrados</h4>
          <div class="d-flex align-items-center gap-2">
            <div class="input-group input-group-sm" style="width: 220px;">
              <label class="input-group-text" for="limitSelect">Itens</label>
              <select id="limitSelect" class="form-select" aria-label="Quantidade por página">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
            <div class="input-group input-group-sm" style="width: 220px;">
              <label class="input-group-text" for="competenciaInput">Competência</label>
              <input type="month" id="competenciaInput" class="form-control" aria-label="Competência mínima" />
            </div>
            <button id="logsBtn" class="btn btn-info">Logs de Cadastros</button>
            <button id="excluirBtn" class="btn btn-danger">Excluir Registro</button>
            <button id="novoCadastroBtn" class="btn btn-success custom-btn">
              <i class="fa fa-plus me-1"></i> Novo Cadastro
            </button>
          </div>
        </div>

        
        <div id="mensagem" aria-live="polite"></div>

        
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle text-center" id="clientesTable">
            <thead class="table-dark">
              <tr>
                <th>Contrato</th>
                <th>Matrícula</th>
                <th>Competência Pagamento</th>
                <th>Beneficiário</th>
                <th>Valor (R$)</th>
              </tr>
            </thead>
            <tbody id="clientesTbody">
              <tr class="table-skeleton"><td colspan="5"></td></tr>
              <tr class="table-skeleton"><td colspan="5"></td></tr>
              <tr class="table-skeleton"><td colspan="5"></td></tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-2">
          <small id="pageInfo" class="text-muted">-</small>
          <nav aria-label="Paginação de clientes">
            <ul class="pagination pagination-sm justify-content-center m-0" id="paginacao"></ul>
          </nav>
        </div>
      </div>
    </main>

    
    <div class="modal fade" id="matriculaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header custom-modal-header text-white">
            <h5 class="modal-title">Iniciar Novo Cadastro</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="matriculaForm" novalidate>
              <label for="matriculaInput" class="form-label">
                Digite a Matrícula <span class="required-star">*</span>
              </label>
              <input
                type="text"
                id="matriculaInput"
                class="form-control"
                required
                inputmode="numeric"
                minlength="5"
                maxlength="20"
                aria-describedby="matriculaHelp"
                autocomplete="off"/>
              <div id="matriculaHelp" class="form-text">Somente números.</div>

              <div id="matriculaLoading" class="mt-2 visually-hidden spinner-inline">
                <div class="spinner-border" role="status" aria-hidden="true"></div>
                <span>Carregando dados da Matrícula...</span>
              </div>

              <button type="submit" class="btn btn-success custom-btn w-100 mt-3">Próximo</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    
    <div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header custom-modal-header text-white">
            <h5 class="modal-title">Cadastrar Novo Cliente</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <form id="clienteForm" class="modal-body row g-3 needs-validation" novalidate></form>

          <div class="modal-footer mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="salvarBtn" type="submit" form="clienteForm" class="btn btn-success custom-btn">
              <span class="save-text">Salvar Cliente</span>
              <span class="save-loading visually-hidden spinner-inline">
                <span class="spinner-border" role="status" aria-hidden="true"></span>
                <span>Salvandoâ€¦</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    
    <div class="modal fade" id="logsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header custom-modal-header text-white">
            <h5 class="modal-title">Logs de Cadastros</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="logsForm" class="row g-3 align-items-end">
              <div class="col-auto">
                <label for="logsDate" class="form-label">Data de Processamento</label>
                <input id="logsDate" name="logsDate" type="date" class="form-control" required>
              </div>
              <div class="col-auto">
                <button id="buscarLogsBtn" class="btn btn-primary" type="submit">Buscar</button>
              </div>
              <div class="col-auto">
                <button id="exportLogsBtn" class="btn btn-outline-secondary" type="button" disabled>Exportar CSV</button>
              </div>
            </form>
            <div class="table-responsive mt-3" id="logsResults" style="max-height:60vh; overflow:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header custom-modal-header text-white">
            <h5 class="modal-title">Excluir Registro</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <form id="deleteForm" class="modal-body row g-3 needs-validation" novalidate>
            <div class="col-12">
              <label for="delDate" class="form-label">Data de Processamento</label>
              <input id="delDate" name="delDate" type="date" class="form-control" required>
            </div>
            <div class="col-12">
              <label for="delGuia" class="form-label">Nº da Guia (GUIA_COD)</label>
              <input id="delGuia" name="delGuia" type="text" class="form-control" required>
            </div>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button id="confirmDeleteBtn" type="submit" form="deleteForm" class="btn btn-danger">Excluir</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header custom-modal-header text-white">
            <h5 class="modal-title">Ajuda e Documentação</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height:70vh; overflow:auto;">
            <div class="small">
              <h6>Visão Geral</h6>
              <p>Esta tela permite visualizar cadastros recentes, criar novos registros, consultar logs por data e excluir registros específicos.</p>

              <h6>Barra Superior</h6>
              <ul>
                <li><b>Ajuda</b>: abre esta documentação.</li>
                <li><b>Sair</b>: encerra a sessão do usuário.</li>
              </ul>

              <h6>Lista Principal</h6>
              <ul>
                <li><b>Itens</b>: controla a quantidade mostrada por página.</li>
                <li><b>Tabela</b>: exibe Contrato, Matrícula, Competência Pagamento, Beneficiário e Valor.</li>
                <li><b>Paginação</b>: navegue entre as páginas quando houver muitos registros.</li>
              </ul>

              <h6>Ações</h6>
              <ul>
                <li><b>Novo Cadastro</b>: inicia pelo número da Matrícula; o sistema tenta <i>preencher automaticamente</i> dados do último registro da mesma Matrícula. Em seguida, edite os campos e clique em <b>Salvar Cliente</b>.</li>
                <li><b>Logs de Cadastros</b>: selecione a <b>Data de Processamento</b> para listar todos os registros daquela data. Use <b>Exportar CSV</b> para baixar o arquivo (compatível com Excel) com os mesmos nomes de colunas da tabela Oracle.</li>
                <li><b>Excluir Registro</b>: informe <b>Data de Processamento</b> e <b>GUIA_COD</b> (número da guia). A exclusão é feita somente quando ambos os campos são fornecidos.</li>
              </ul>

              <h6>Formulário de Cadastro</h6>
              <p>Campos com <span class="required-star">*</span> são obrigatórios. Preencha exatamente como indicado:</p>
              <ul>
                <li>Matrícula, COD (Família), CONTRATO, GUIA_COD_ID (guia internação), VALOR (remoção), QTDE, UNIMED_EXEC, INDICACAO_CLINICA, FORNECEDOR, IDADE, GUIA_COD (guia vinculada), GUIA_COD_PREST, NOME_PREST, COD_CNTRAT_CART, COD_DEPNTE, Beneficiário e ITEM_COD.</li>
                <li><b>Datas</b>: use o formato AAAA-MM-DD.</li>
                <li><b>Números</b>: aceitam vírgula ou ponto; serão normalizados.</li>
                <li>Alguns campos são preenchidos automaticamente (competências, flags e defaults de negócio), mas podem aparecer somente para leitura.</li>
              </ul>

              <h6>Mensagens e Erros</h6>
              <ul>
                <li>Erros de validação destacam campos obrigatórios não preenchidos.</li>
                <li>Falhas de comunicação com o Oracle exibem mensagem e podem ser tentadas novamente.</li>
              </ul>

              <h6>Segurança e Sessão</h6>
              <ul>
                <li>Por inatividade, a sessão expira após alguns minutos; um aviso é exibido e o login é solicitado novamente.</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API = {
        clientes: (page, limit, timeout = 60000, competencia = "") => {
          const params = new URLSearchParams({
            page: String(page),
            limit: String(limit),
            timeout: String(timeout),
          });
          if (competencia) params.append("competencia_from", competencia);
          return `/api/clientes?${params.toString()}`;
        },
        ultimoCadastro: (matricula) =>
          `/api/ultimo-cadastro-por-matricula?matricula=${encodeURIComponent(matricula)}`,
        cadastrar: `/api/cadastrar-cliente`,
        logs: (date, timeout = 60000, limit = 500) =>
          `/api/logs?date=${encodeURIComponent(date)}&timeout=${timeout}&limit=${limit}`,
        logsExport: (date, timeout = 60000) =>
          `/api/logs/export?date=${encodeURIComponent(date)}&timeout=${timeout}`,
        excluir: (timeout = 60000) => `/api/excluir-registro?timeout=${timeout}`,
      };

      const escapeHTML = (s) => {
        if (s === null || s === undefined) return "";
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      const formatCurrencyBRL = (v) => {
        const n = Number(v ?? 0);
        if (Number.isNaN(n)) return "R$ 0,00";
        return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      };

      let lastController = null;
      const fetchJSON = async (url, options = {}, timeoutMs = 60000) => {
        const controller = new AbortController();
        let timedOut = false;

        const timer = timeoutMs
          ? setTimeout(() => {
              timedOut = true;
              controller.abort();
            }, timeoutMs)
          : null;

        if (lastController) {
          lastController.abort();
        }
        lastController = controller;

        const opts = {
          credentials: "same-origin",
          headers: { "Accept": "application/json", ...(options.headers || {}) },
          signal: controller.signal,
          ...options,
        };

        try {
          const res = await fetch(url, opts);
          if (timer) clearTimeout(timer);

          if (res.status === 401) {
            window.location.href = "/login";
            throw new Error("Não autenticado.");
          }

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            const msg = data?.msg || `Erro HTTP ${res.status}`;
            throw new Error(msg);
          }
          return data;
        } catch (e) {
          if (timer) clearTimeout(timer);
          if (e && e.name === "AbortError") {
            if (timedOut) {
              throw new Error("Tempo limite da requisição excedido.");
            }
            console.warn("Requisição abortada (substituída por outra):", url);
            return null;
          }
          throw e;
        } finally {
          if (lastController === controller) {
            lastController = null;
          }
        }
      };

      const showMessage = (text, type = "info") => {
        const mensagemDiv = document.getElementById("mensagem");
        mensagemDiv.innerHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${escapeHTML(text)}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>`;
      };

      const setBtnLoading = (btn, isLoading) => {
        const txt = btn.querySelector(".save-text");
        const loading = btn.querySelector(".save-loading");
        if (isLoading) {
          btn.disabled = true;
          txt.classList.add("visually-hidden");
          loading.classList.remove("visually-hidden");
        } else {
          btn.disabled = false;
          txt.classList.remove("visually-hidden");
          loading.classList.add("visually-hidden");
        }
      };

      let currentPage = 1;
      let limit = Number(localStorage.getItem("clientes.limit") || 10);
      let clienteModal, matriculaModal;  // <â€” serão atribuídos mais abaixo
      let formDirty = false;

      const CAMPOS_OBRIGATORIOS_USER = [
        "Matrícula",
        "COD", // Cód Família da Matrícula
        "CONTRATO",
        "GUIA_COD_ID",
        "VALOR",
        "QTDE",
        "UNIMED_EXEC",
        "INDICACAO_CLINICA",
        "FORNECEDOR",
        "IDADE",
        "GUIA_COD",
        "GUIA_COD_PREST",
        "NOME_PREST",
        "COD_CNTRAT_CART",
        "COD_DEPNTE",
        "BENEFICIARIO",
        "ITEM_COD"
      ];

      const CAMPOS_RESET = [
        "VALOR","QTDE","UNIMED_EXEC","INDICACAO_CLINICA","FORNECEDOR","IDADE",
        "GUIA_COD","GUIA_COD_PREST","NOME_PREST","VAL_FAT","FAT_NRO","OBSERVACO"
      ];

      const RULES = {
        MATRICULA: { mode: "user" },
        VALOR: { mode: "user" },
        QTDE: { mode: "user" },
        UNIMED_EXEC: { mode: "user" },
        INDICACAO_CLINICA: { mode: "user" },
        FORNECEDOR: { mode: "user" },
        IDADE: { mode: "user" },
        GUIA_COD: { mode: "user" },
        GUIA_COD_PREST: { mode: "user" },
        NOME_PREST: { mode: "user" },

        ORIGEM_REDE: { mode: "select", options: ["OUTRA OPERADORA","REDE LOCAL"], default: "OUTRA OPERADORA" },
        CARATER_ATENDIMENTO: { mode: "select", options: ["E","U"], default: "E" },

        SEQUENCIA: { mode: "auto", defaultFrom: "PROXIMA_SEQUENCIA" },
        TIPO_ATENDIMENTO: { mode: "auto", default: "REMOCAO" },
        COD: { mode: "user" },
        STATUS: { mode: "auto", default: "" },
        DATPROCESSAMENTO: { mode: "auto", default: () => new Date().toISOString().slice(0,10) },
        CONTRATO: { mode: "user" },
        COMPETENCIA_PAGAMENTO: { mode: "auto", default: "" },
        GUIA_COD_ID: { mode: "user" },
        TP_GUIA: { mode: "auto", default: "P" },
        ITEM_COD: { mode: "user" },
        TIP_GUIA: { mode: "auto", default: "REMOCAO" },
        DEMONSTRATIVO_FATURA: { mode: "auto", default: "" },
        COMPETENCIA_PROCESSAMENTO: { mode: "auto", default: () => {
          const d = new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
        }},
        GUCID_COD_CID: { mode: "auto", default: "" },
        TP_ITEM: { mode: "auto", default: "Taxa" },
        SEQ: { mode: "auto", default: 1 },
        DATA_EXECUCAO: { mode: "auto", default: () => new Date().toISOString().slice(0,10) },
        LOCALIDADE: { mode: "auto", default: "LOCAL" },
        GRUPO_FREQUENCIA: { mode: "auto", default: "" },
        PREST_PAG: { mode: "auto", default: "" },
        TIP_FOR: { mode: "auto", default: "REM" },
        ITEM_DESCRI: { mode: "auto", default: "" },
        NM_SOLIC: { mode: "auto", default: "" },
        NC: { mode: "auto", default: "S" },
        TIPO_LANCAMENTO: { mode: "auto", default: "PRODUCAO - REMOCAO" },
        CAPITULO: { mode: "auto", default: "TAXA" },
        GRUPO: { mode: "auto", default: "TAXA" },
        SUBGRUPO: { mode: "auto", default: "TAXA" },
        TIPO_ACOMODACAO: { mode: "auto", default: "" },
        PARTICIPACAO: { mode: "auto", default: "SEM PARTICIPACAO" },
        UNIMED: { mode: "auto", default: "LOCAL" },
        CBO_EXEC_NRO: { mode: "auto", default: "" },
        CBO_SOLIC_NRO: { mode: "auto", default: "" },
        VAL_FAT: { mode: "auto", default: 0 },
        FAT_NRO: { mode: "auto", default: 0 },
        COD_PREST_PAGTO: { mode: "auto", default: "" },
        UNI_COD_RESPON: { mode: "auto", default: 177 },

        COD_CNTRAT_CART: { mode: "user" },
        COD_DEPNTE: { mode: "user" },
        BENEFICIARIO: { mode: "user" },

        GUITE_NRO_SENHA_SOLIT: { mode: "auto", default: "" },
        PRESTADOR_EXECUTANTE_ITEM: { mode: "auto", default: "" },
        PARAMETRO_INT: { mode: "auto", default: "" },
        PARAMETRO_LOC: { mode: "auto", default: "" },
        CPFCNPJ_EXEC: { mode: "auto", default: "" },
        CPFCNPJ_SOL: { mode: "auto", default: "" },
        OBSERVACO: { mode: "auto", default: "" },
      };

      const CAMPOS = [
        { id:"MATRICULA", label:"Matrícula", type:"text" },
        { id:"VALOR", label:"Valor", type:"number", step:"0.01" },
        { id:"QTDE", label:"Quantidade", type:"number", step:"1", default: 1 },
        { id:"UNIMED_EXEC", label:"Código Unimed Executante", type:"text" },
        { id:"INDICACAO_CLINICA", label:"Indicação Clínica (Opcional)", type:"text" },
        { id:"FORNECEDOR", label:"Fornecedor", type:"text" },
        { id:"IDADE", label:"Idade do Beneficiário", type:"number", step:"1" },
        { id:"GUIA_COD", label:"Nº Guia Vinculada à Remoção", type:"text" },
        { id:"GUIA_COD_PREST", label:"Código Guia Prestador", type:"text" },
        { id:"NOME_PREST", label:"Nome Prestador", type:"text" },

        { id:"ORIGEM_REDE", label:"Origem Rede", type:"select" },
        { id:"CARATER_ATENDIMENTO", label:"Caráter Atendimento", type:"select" },

        { id:"SEQUENCIA", label:"Sequência (Geral)", type:"number", step:"1" },
        { id:"TIPO_ATENDIMENTO", label:"Tipo Atendimento", type:"text" },
        { id:"COD", label:"Cód. Família da Matrícula", type:"text" },
        { id:"STATUS", label:"Status", type:"text" },
        { id:"DATPROCESSAMENTO", label:"Data Processamento", type:"date" },
        { id:"CONTRATO", label:"Nº Contrato", type:"text" },
        { id:"COMPETENCIA_PAGAMENTO", label:"Competência Pagamento", type:"text" },
        { id:"GUIA_COD_ID", label:"ID da Guia (Internação)", type:"text" },
        { id:"TP_GUIA", label:"TP Guia", type:"text" },
        { id:"ITEM_COD", label:"Item Cód", type:"text" },
        { id:"TIP_GUIA", label:"Tip Guia", type:"text" },
        { id:"DEMONSTRATIVO_FATURA", label:"Demonstrativo Fatura", type:"text" },
        { id:"COMPETENCIA_PROCESSAMENTO", label:"Competência Processamento (YYYYMM)", type:"text" },
        { id:"GUCID_COD_CID", label:"GUCID Cód CID", type:"text" },
        { id:"TP_ITEM", label:"TP Item", type:"text" },
        { id:"SEQ", label:"Seq (Item)", type:"number", step:"1" },
        { id:"DATA_EXECUCAO", label:"Data Execução", type:"date" },
        { id:"LOCALIDADE", label:"Localidade", type:"text" },
        { id:"GRUPO_FREQUENCIA", label:"Grupo Frequência", type:"text" },
        { id:"PREST_PAG", label:"Prest Pag", type:"text" }, // <-- VÍRGULA ADICIONADA
        { id:"TIP_FOR", label:"Tip For", type:"text" },
        { id:"ITEM_DESCRI", label:"Item Descrição", type:"text" },
        { id:"NM_SOLIC", label:"Nome Solic", type:"text" },
        { id:"NC", label:"NC", type:"text" },
        { id:"TIPO_LANCAMENTO", label:"Tipo Lançamento", type:"text" },
        { id:"CAPITULO", label:"Capítulo", type:"text" },
        { id:"GRUPO", label:"Grupo", type:"text" },
        { id:"SUBGRUPO", label:"Subgrupo", type:"text" },
        { id:"TIPO_ACOMODACAO", label:"Tipo Acomodação", type:"text" },
        { id:"PARTICIPACAO", label:"Participação", type:"text" },
        { id:"UNIMED", label:"Unimed", type:"text" },
        { id:"CBO_EXEC_NRO", label:"CBO Exec Nº", type:"text" },
        { id:"CBO_SOLIC_NRO", label:"CBO Solic Nº", type:"text" },
        { id:"VAL_FAT", label:"Val Fat", type:"number", step:"0.01" },
        { id:"FAT_NRO", label:"Fat Nº", type:"number", step:"1" },
        { id:"COD_PREST_PAGTO", label:"Cód Prest Pagto", type:"text" },
        { id:"UNI_COD_RESPON", label:"Unimed Cód Responsável", type:"number", step:"1" },

        { id:"COD_CNTRAT_CART", label:"Cód Contrato Carteira", type:"text" },
        { id:"COD_DEPNTE", label:"Cód Dependente", type:"text" },
        { id:"BENEFICIARIO", label:"Nome do Beneficiário", type:"text" }, // Corrigido para corresponder ao backend

        { id:"GUITE_NRO_SENHA_SOLIT", label:"Guite Nº Senha Solicitado", type:"text" },
        { id:"PRESTADOR_EXECUTANTE_ITEM", label:"Prestador Executante Item", type:"text" },
        { id:"PARAMETRO_INT", label:"Parâmetro Int", type:"text" },
        { id:"PARAMETRO_LOC", label:"Parâmetro Loc", type:"text" },
        { id:"CPFCNPJ_EXEC", label:"CPF/CNPJ Executante", type:"text" },
        { id:"CPFCNPJ_SOL", label:"CPF/CNPJ Solicitante", type:"text" },
        { id:"OBSERVACO", label:"Observação", type:"text" },
      ];

      const clientesTbody = document.getElementById("clientesTbody");
      const paginacao = document.getElementById("paginacao");
      const pageInfo = document.getElementById("pageInfo");
      const limitSelect = document.getElementById("limitSelect");
      const competenciaInput = document.getElementById("competenciaInput");

      Array.from(limitSelect?.options || []).forEach((opt) => {
        if (Number(opt.value) === limit) {
          opt.selected = true;
        }
      });

      const renderSkeleton = () => {
        if (!clientesTbody) return;
        clientesTbody.innerHTML = `
          <tr class="table-skeleton"><td colspan="5"></td></tr>
          <tr class="table-skeleton"><td colspan="5"></td></tr>
          <tr class="table-skeleton"><td colspan="5"></td></tr>
        `;
        if (pageInfo) pageInfo.textContent = "Carregando clientes...";
      };

      const montarPaginacao = (total, page, pageSize) => {
        if (!paginacao || !pageInfo) return;
        paginacao.innerHTML = "";
        const safeTotal = Number.isFinite(total) ? Math.max(0, total) : 0;
        const totalPages = safeTotal > 0 ? Math.ceil(safeTotal / pageSize) : 0;

        if (safeTotal === 0) {
          pageInfo.textContent = "Nenhum registro encontrado.";
        } else {
          const start = (page - 1) * pageSize + 1;
          const end = Math.min(safeTotal, page * pageSize);
          pageInfo.textContent = `Mostrando ${start}-${end} de ${safeTotal}`;
        }

        if (totalPages <= 1) {
          return;
        }

        const addItem = (label, targetPage, disabled = false, active = false) => {
          const li = document.createElement("li");
          li.className = `page-item${disabled ? " disabled" : ""}${active ? " active" : ""}`;
          li.innerHTML = `<button type="button" class="page-link" data-page="${targetPage}">${label}</button>`;
          paginacao.appendChild(li);
        };

        addItem("&laquo;", Math.max(1, page - 1), page <= 1);
        const windowSize = 5;
        let startPage = Math.max(1, page - Math.floor(windowSize / 2));
        let endPage = Math.min(totalPages, startPage + windowSize - 1);
        if (endPage - startPage < windowSize - 1) {
          startPage = Math.max(1, endPage - windowSize + 1);
        }
        for (let p = startPage; p <= endPage; p += 1) {
          addItem(String(p), p, false, p === page);
        }
        addItem("&raquo;", Math.min(totalPages, page + 1), page >= totalPages);
      };

      const getCompetenciaFilter = () => {
        const raw = competenciaInput?.value || "";
        if (!raw) return "";
        const [year, month] = raw.split("-");
        if (!year || !month) return "";
        return `${year}${month}`;
      };

      if (competenciaInput) {
        const stored = localStorage.getItem("clientes.competencia");
        if (stored && /^\d{6}$/.test(stored)) {
          competenciaInput.value = `${stored.slice(0, 4)}-${stored.slice(4)}`;
        } else {
          const now = new Date();
          const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
          competenciaInput.value = defaultMonth;
          localStorage.setItem("clientes.competencia", defaultMonth.replace("-", ""));
        }
      }

      const carregarClientes = async (page = 1) => {
        currentPage = page;
        renderSkeleton();
        try {
          const oracleTimeoutMs = 90000;
          const browserTimeoutMs = 110000;
          const competenciaFilter = getCompetenciaFilter();
          const data = await fetchJSON(
            API.clientes(page, limit, oracleTimeoutMs, competenciaFilter),
            {},
            browserTimeoutMs
          );
          if (!data) return;
          const clientes = data?.clientes || [];
          const total = data?.total ?? clientes.length;

          if (!clientes.length) {
            clientesTbody.innerHTML = `<tr><td colspan="5" class="text-center">Nenhum cliente encontrado.</td></tr>`;
            if (pageInfo) pageInfo.textContent = "Nenhum registro encontrado.";
          } else {
            clientesTbody.innerHTML = clientes.map((c) => `
              <tr>
                <td>${escapeHTML(c.CONTRATO ?? "-")}</td>
                <td>${escapeHTML(c.MATRICULA ?? "-")}</td>
                <td>${escapeHTML(c.COMPETENCIA_PAGAMENTO ?? "-")}</td>
                <td>${escapeHTML(c.BENEFICIARIO ?? "-")}</td>
                <td>${formatCurrencyBRL(c.VALOR)}</td>
              </tr>
            `).join("");
          }
          montarPaginacao(total, currentPage, limit);
        } catch (err) {
          console.error(err);
          showMessage((err && err.message) || "Erro ao carregar clientes.", "danger");
          clientesTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados.</td></tr>`;
          if (pageInfo) pageInfo.textContent = "Erro ao carregar clientes.";
        }
      };

      paginacao?.addEventListener("click", (event) => {
        const btn = event.target.closest("button.page-link");
        if (!btn) return;
        const nextPage = Number(btn.dataset.page || "1");
        if (!Number.isNaN(nextPage) && nextPage > 0 && nextPage !== currentPage) {
          carregarClientes(nextPage);
        }
      });

      limitSelect?.addEventListener("change", () => {
        limit = Math.max(1, Number(limitSelect.value || "10"));
        localStorage.setItem("clientes.limit", String(limit));
        carregarClientes(1);
      });

      competenciaInput?.addEventListener("change", () => {
        const raw = competenciaInput.value;
        const normalized = raw ? raw.replace("-", "") : "";
        localStorage.setItem("clientes.competencia", normalized);
        carregarClientes(1);
      });

      const toggleBtnBusy = (btn, isLoading, text = "Processando...") => {
        if (!btn) return;
        if (isLoading) {
          if (!btn.dataset.originalText) {
            btn.dataset.originalText = btn.innerHTML;
          }
          btn.disabled = true;
          btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${text}`;
        } else {
          btn.disabled = false;
          if (btn.dataset.originalText) {
            btn.innerHTML = btn.dataset.originalText;
            delete btn.dataset.originalText;
          }
        }
      };

      const matriculaModalEl = document.getElementById("matriculaModal");
      const clienteModalEl = document.getElementById("clienteModal");
      const logsModalEl = document.getElementById("logsModal");
      const deleteModalEl = document.getElementById("deleteModal");
      const helpModalEl = document.getElementById("helpModal");

      matriculaModal = matriculaModalEl ? new bootstrap.Modal(matriculaModalEl) : null;
      clienteModal = clienteModalEl ? new bootstrap.Modal(clienteModalEl) : null;
      const logsModal = logsModalEl ? new bootstrap.Modal(logsModalEl) : null;
      const deleteModal = deleteModalEl ? new bootstrap.Modal(deleteModalEl) : null;
      const helpModal = helpModalEl ? new bootstrap.Modal(helpModalEl) : null;

      const matriculaForm = document.getElementById("matriculaForm");
      const matriculaInput = document.getElementById("matriculaInput");
      const clienteForm = document.getElementById("clienteForm");
      const salvarBtn = document.getElementById("salvarBtn");
      const matriculaLoading = document.getElementById("matriculaLoading");
      const logsForm = document.getElementById("logsForm");
      const logsDate = document.getElementById("logsDate");
      const logsResults = document.getElementById("logsResults");
      const exportLogsBtn = document.getElementById("exportLogsBtn");
      const buscarLogsBtn = document.getElementById("buscarLogsBtn");
      const deleteForm = document.getElementById("deleteForm");
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
      const delDateInput = document.getElementById("delDate");
      const delGuiaInput = document.getElementById("delGuia");

      document.getElementById("logoutBtn")?.addEventListener("click", () => {
        window.location.href = "/logout";
      });

      document.getElementById("novoCadastroBtn")?.addEventListener("click", () => {
        matriculaForm?.reset();
        matriculaForm?.classList.remove("was-validated");
        matriculaLoading?.classList.add("visually-hidden");
        matriculaModal?.show();
        setTimeout(() => matriculaInput?.focus(), 200);
      });

      document.getElementById("logsBtn")?.addEventListener("click", () => {
        logsForm?.reset();
        logsForm?.classList.remove("was-validated");
        logsResults.innerHTML = "";
        if (exportLogsBtn) {
          exportLogsBtn.disabled = true;
          delete exportLogsBtn.dataset.date;
        }
        if (logsDate) {
          logsDate.value = new Date().toISOString().slice(0, 10);
        }
        logsModal?.show();
      });

      document.getElementById("excluirBtn")?.addEventListener("click", () => {
        deleteForm?.reset();
        deleteForm?.classList.remove("was-validated");
        deleteModal?.show();
      });

      document.getElementById("helpBtn")?.addEventListener("click", () => {
        helpModal?.show();
      });

      const valueOr = (v, fallback) => (v === undefined || v === null || v === "" ? fallback : v);

      function applyBusinessRulesFromRules(raw) {
        const out = { ...raw };

        Object.entries(RULES).forEach(([field, rule]) => {
          if (rule.mode === "auto") {
            const fromApi = rule.defaultFrom ? raw[rule.defaultFrom] : undefined;
            const val = fromApi ?? (typeof rule.default === "function" ? rule.default() : rule.default);
            out[field] = val;
          }
          if (rule.mode === "select") {
            const def = typeof rule.default === "function" ? rule.default() : rule.default;
            out[field] = valueOr(raw[field], def);
          }
        });

        ["DATPROCESSAMENTO", "DATA_EXECUCAO"].forEach((k) => {
          if (out[k]) out[k] = String(out[k]).split("T")[0];
        });

        ["VALOR", "SEQ", "VAL_FAT", "FAT_NRO", "UNI_COD_RESPON", "IDADE", "QTDE", "SEQUENCIA"].forEach((k) => {
          if (out[k] !== undefined && out[k] !== null && out[k] !== "") {
            const n = Number(String(out[k]).replace(",", "."));
            if (!Number.isNaN(n)) out[k] = n;
          }
        });

        out["SEQ"] = 1;
        return out;
      }

      const montarFormulario = (dados = {}) => {
        if (!clienteForm) return;
        clienteForm.innerHTML = "";
        clienteForm.classList.remove("was-validated");
        formDirty = false;

        const base = applyBusinessRulesFromRules(dados);

        CAMPOS.forEach((campo) => {
          const rule = RULES[campo.id] || { mode: "user" };
          const isRequired = CAMPOS_OBRIGATORIOS_USER.includes(campo.id) && !rule.optional;
          const readOnly = rule.mode === "auto";
          const val = base[campo.id] ?? "";
          const requiredStar = isRequired ? `<span class="required-star">*</span>` : "";
          const readOnlyClass = readOnly ? "readonly-like" : "";
          const stepAttr = campo.type === "number" && campo.step ? ` step="${campo.step}"` : "";

          let control = "";
          if (campo.type === "select" && Array.isArray(rule.options)) {
            const options = rule.options.map((opt) => {
              const selected = String(opt) === String(val) ? " selected" : "";
              return `<option value="${escapeHTML(opt)}"${selected}>${escapeHTML(opt)}</option>`;
            }).join("");
            const disabledAttr = readOnly ? " disabled" : "";
            control = `<select class="form-select ${readOnlyClass}" id="${campo.id}" name="${campo.id}"${disabledAttr}${isRequired ? " required" : ""}>${options}</select>`;
            if (readOnly) {
              control += `<input type="hidden" name="${campo.id}" value="${escapeHTML(val)}">`;
            }
          } else {
            const typeAttr = campo.type || "text";
            const safeVal = val === null || val === undefined ? "" : val;
            control = `<input type="${typeAttr}" class="form-control ${readOnlyClass}" id="${campo.id}" name="${campo.id}" value="${escapeHTML(safeVal)}"${isRequired ? " required" : ""}${readOnly ? " readonly" : ""}${stepAttr}>`;
          }

          clienteForm.insertAdjacentHTML(
            "beforeend",
            `
            <div class="col-md-4 col-sm-6">
              <label class="form-label" for="${campo.id}">${campo.label}${requiredStar}</label>
              ${control}
            </div>
            `
          );
        });

        const firstInput = clienteForm.querySelector("input:not([type='hidden']), select, textarea");
        if (firstInput) firstInput.focus();
      };

      matriculaForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        matriculaForm.classList.add("was-validated");
        const matricula = (matriculaInput?.value || "").trim();
        if (!matricula) return;

        matriculaInput.disabled = true;
        matriculaLoading?.classList.remove("visually-hidden");
        try {
          const result = await fetchJSON(API.ultimoCadastro(matricula));
          const dados = result?.data || {};
          montarFormulario({ ...dados, MATRICULA: matricula });
          matriculaModal?.hide();
          clienteModal?.show();
          showMessage(result?.msg || "Dados carregados.", "success");
        } catch (err) {
          console.error(err);
          showMessage(err.message || "Erro ao buscar matricula.", "danger");
        } finally {
          matriculaInput.disabled = false;
          matriculaLoading?.classList.add("visually-hidden");
        }
      });

      clienteForm?.addEventListener("input", () => {
        formDirty = true;
      });
      clienteForm?.addEventListener("change", () => {
        formDirty = true;

      });

      clienteForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        clienteForm.classList.add("was-validated");
        if (!clienteForm.checkValidity()) return;

        const formData = new FormData(clienteForm);
        const payload = {};
        formData.forEach((value, key) => {
          payload[key] = typeof value === "string" ? value.trim() : value;
        });

        setBtnLoading(salvarBtn, true);
        try {
          const result = await fetchJSON(API.cadastrar, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          showMessage(result?.msg || "Cliente cadastrado com sucesso.", "success");
          formDirty = false;
          clienteModal?.hide();
          carregarClientes(1);
        } catch (err) {
          console.error(err);
          showMessage(err.message || "Erro ao salvar cliente.", "danger");
        } finally {
          setBtnLoading(salvarBtn, false);
        }
      });

      clienteModalEl?.addEventListener("hide.bs.modal", (event) => {
        if (formDirty) {
          const discard = confirm("Existem alteracoes nao salvas. Deseja descartar?");
          if (!discard) {
            event.preventDefault();
            event.stopImmediatePropagation();
            return;
          }
        }
        formDirty = false;
        clienteForm?.classList.remove("was-validated");
        clienteForm?.replaceChildren();
      });

      window.addEventListener("beforeunload", (event) => {
        if (formDirty) {
          event.preventDefault();
          event.returnValue = "";
        }
      });

      const LOG_COLUMNS = [
        { key: "DATPROCESSAMENTO", label: "Data Processamento" },
        { key: "GUIA_COD_ID", label: "Guia (ID)" },
        { key: "GUIA_COD", label: "Guia" },
        { key: "MATRICULA", label: "Matrícula" },
        { key: "BENEFICIARIO", label: "Beneficiário" },
        { key: "VALOR", label: "Valor (R$)" },
        { key: "TIPO_ATENDIMENTO", label: "Tipo Atendimento" },
      ];

      const renderLogsTable = (columns = [], rows = []) => {
        if (!logsResults) return;
        if (!rows.length) {
          logsResults.innerHTML = `<p class="text-muted mb-0">Nenhum registro para a data informada.</p>`;
          return;
        }

        const activeColumns = columns?.length ? columns : LOG_COLUMNS.map((c) => c.key);
        const header = LOG_COLUMNS.filter((col) => activeColumns.includes(col.key))
          .map((col) => `<th scope="col">${escapeHTML(col.label)}</th>`)
          .join("");

        const body = rows
          .map(
            (row) =>
              `<tr>${LOG_COLUMNS.filter((col) => activeColumns.includes(col.key))
                .map((col) => {
                  if (col.key === "VALOR") {
                    return `<td>${formatCurrencyBRL(row[col.key])}</td>`;
                  }
                  return `<td>${escapeHTML(row[col.key] ?? "")}</td>`;
                })
                .join("")}</tr>`
          )
          .join("");

        logsResults.innerHTML = `
          <table class="table table-striped table-sm">
            <thead class="table-light"><tr>${header}</tr></thead>
            <tbody>${body}</tbody>
          </table>
        `;
      };

      logsForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        logsForm.classList.add("was-validated");
        const date = logsDate?.value;
        if (!date) return;
        toggleBtnBusy(buscarLogsBtn, true, "Buscando...");
        if (exportLogsBtn) {
          exportLogsBtn.disabled = true;
          delete exportLogsBtn.dataset.date;
        }
        logsResults.innerHTML = "";
        try {
          const oracleTimeout = 120000;
          const browserTimeout = 140000;
          const result = await fetchJSON(
            API.logs(date, oracleTimeout, 500),
            {},
            browserTimeout
          );
          if (!result) return;
          renderLogsTable(result?.columns || [], result?.rows || []);
          const total = result?.total ?? 0;
          if (result?.partial) {
            showMessage(
              `Logs carregados parcialmente (${total} registro${total === 1 ? "" : "s"}). Tente refinar a data ou exportar para CSV.`,
              "warning"
            );
          } else {
            showMessage(`Logs carregados (${total} registro${total === 1 ? "" : "s"}).`, "success");
          }
          if (exportLogsBtn && total > 0) {
            exportLogsBtn.disabled = false;
            exportLogsBtn.dataset.date = date;
          }
        } catch (err) {
          console.error(err);
          showMessage(err.message || "Erro ao buscar logs.", "danger");
          logsResults.innerHTML = `<p class="text-danger mb-0">${escapeHTML(err.message || "Erro ao buscar logs.")}</p>`;
        } finally {
          toggleBtnBusy(buscarLogsBtn, false);
        }
      });

      exportLogsBtn?.addEventListener("click", () => {
        const date = exportLogsBtn.dataset.date;
        if (!date) return;
        const oracleTimeout = 120000;
        window.open(API.logsExport(date, oracleTimeout), "_blank", "noopener");
      });

      deleteForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        deleteForm.classList.add("was-validated");
        const date = delDateInput?.value;
        const guia = (delGuiaInput?.value || "").trim();
        if (!date || !guia) return;

        toggleBtnBusy(confirmDeleteBtn, true, "Excluindo...");
        try {
          const payload = { DATPROCESSAMENTO: date, GUIA_COD: guia };
          const oracleTimeout = 90000;
          const browserTimeout = 110000;
          const result = await fetchJSON(
            API.excluir(oracleTimeout),
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            },
            browserTimeout
          );
          if (!result) return;
          showMessage(result?.msg || "Registro excluido.", "success");
          deleteModal?.hide();
          carregarClientes(currentPage);
        } catch (err) {
          console.error(err);
          showMessage(err.message || "Erro ao excluir registro.", "danger");
        } finally {
          toggleBtnBusy(confirmDeleteBtn, false);
        }
      });

      carregarClientes(1);
    </script>
  </body>
</html>
