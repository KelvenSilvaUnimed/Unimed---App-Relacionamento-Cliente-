      const CAMPOS = [
        // UsuÃ¡rio
        { id:"MATRICULA", label:"Matrícula"}, type:"text" },
        { id:"VALOR", label:"Valor", type:"number", step:"0.01" },
        { id:"QTDE", label:"Quantidade", type:"number", step:"1" },
        { id:"UNIMED_EXEC", label:"CÃ³digo Unimed Executante", type:"text" },
        { id:"INDICACAO_CLINICA", label:"IndicaÃ§Ã£o ClÃ­nica (Opcional)", type:"text" },
        { id:"FORNECEDOR", label:"Fornecedor", type:"text" },
        { id:"IDADE", label:"Idade do Beneficiário", type:"number", step:"1" },
        { id:"GUIA_COD", label:"NÂº Guia Vinculada Ã  RemoÃ§Ã£o", type:"text" },
        { id:"GUIA_COD_PREST", label:"CÃ³digo Guia Prestad", type:"text" },
        { id:"NOME_PREST", label:"Nome Prestador", type:"text" },

        // Selects
        { id:"ORIGEM_REDE", label:"Origem Rede", type:"select" },
        { id:"CARATER_ATENDIMENTO", label:"CarÃ¡ter Atendimento", type:"select" },

        // AutomÃ¡ticos
        { id:"SEQUENCIA", label:"SequÃªncia (Geral)", type:"number", step:"1" },
        { id:"TIPO_ATENDIMENTO", label:"Tipo Atendimento", type:"text" },
        { id:"COD", label:"Cód Família da Matrícula", type:"text" },
        { id:"STATUS", label:"Status", type:"text" },
        { id:"DATPROCESSAMENTO", label:"Data Processamento", type:"date" },
        { id:"CONTRATO", label:"NÂº Contrato", type:"text" },
        { id:"Competência Pagamento", type:"text" },
        { id:"GUIA_COD_ID", label:"ID da Guia (InternaÃ§Ã£o)", type:"text" },
        { id:"TP_GUIA", label:"TP Guia", type:"text" },
        { id:"ITEM_COD", label:"Item CÃ³d", type:"text" },
        { id:"TIP_GUIA", label:"Tip Guia", type:"text" },
        { id:"DEMONSTRATIVO_FATURA", label:"Demonstrativo Fatura", type:"text" },
        { id:"COMPETENCIA_PROCESSAMENTO", label:"CompetÃªncia Processamento (YYYYMM)", type:"text" },
        { id:"GUCID_COD_CID", label:"GUCID CÃ³d CID", type:"text" },
        { id:"TP_ITEM", label:"TP Item", type:"text" },
        { id:"SEQ", label:"Seq (Item)", type:"number", step:"1" },
        { id:"DATA_EXECUCAO", label:"Data ExecuÃ§Ã£o", type:"date" },
        { id:"LOCALIDADE", label:"Localidade", type:"text" },
        { id:"GRUPO_FREQUENCIA", label:"Grupo FrequÃªncia", type:"text" },
        { id:"PREST_PAG", label:"Prest Pag", type:"text" },
        { id:"TIP_FOR", label:"Tip For", type:"text" },
        { id:"ITEM_DESCRI", label:"Item DescriÃ§Ã£o", type:"text" },
        { id:"NM_SOLIC", label:"Nome Solic", type:"text" },
        { id:"NC", label:"NC", type:"text" },
        { id:"TIPO_LANCAMENTO", label:"Tipo LanÃ§amento", type:"text" },
        { id:"CAPITULO", label:"CapÃ­tulo", type:"text" },
        { id:"GRUPO", label:"Grupo", type:"text" },
        { id:"SUBGRUPO", label:"Subgrupo", type:"text" },
        { id:"TIPO_ACOMODACAO", label:"Tipo AcomodaÃ§Ã£o", type:"text" },
        { id:"PARTICIPACAO", label:"ParticipaÃ§Ã£o", type:"text" },
        { id:"UNIMED", label:"Unimed", type:"text" },
        { id:"CBO_EXEC_NRO", label:"CBO Exec NÂº", type:"text" },
        { id:"CBO_SOLIC_NRO", label:"CBO Solic NÂº", type:"text" },
        { id:"VAL_FAT", label:"Val Fat", type:"number", step:"0.01" },
        { id:"FAT_NRO", label:"Fat NÂº", type:"number", step:"1" },
        { id:"COD_PREST_PAGTO", label:"CÃ³d Prest Pagto", type:"text" },
        { id:"UNI_COD_RESPON", label:"Unimed CÃ³d ResponsÃ¡vel", type:"number", step:"1" },

        // AutomÃ¡ticos (SQL)
        { id:"COD_CNTRAT_CART", label:"CÃ³d Contrato Carteira", type:"text" },
        { id:"COD_DEPNTE", label:"CÃ³d Dependente", type:"text" },
        { id:"Beneficiário", label:"Nome do Beneficiário", type:"text" },

        { id:"GUITE_NRO_SENHA_SOLIT", label:"Guite NÂº Senha Solicitado", type:"text" },
        { id:"PRESTADOR_EXECUTANTE_ITEM", label:"Prestador Executante Item", type:"text" },
        { id:"PARAMETRO_INT", label:"ParÃ¢metro Int", type:"text" },
        { id:"PARAMETRO_LOC", label:"ParÃ¢metro Loc", type:"text" },
        { id:"CPFCNPJ_EXEC", label:"CPF/CNPJ Executante", type:"text" },
        { id:"CPFCNPJ_SOL", label:"CPF/CNPJ Solicitado", type:"text" },
        { id:"OBSERVACO", label:"ObservaÃ§Ã£o", type:"text" },
      ];

      // ------------------ Tabela / PaginaÃ§Ã£o ------------------
      const clientesTbody = document.getElementById("clientesTbody");
      const paginacao = document.getElementById("paginacao");
      const pageInfo = document.getElementById("pageInfo");
      const limitSelect = document.getElementById("limitSelect");

      for (const opt of limitSelect.options) {
        if (Number(opt.value) === limit) { opt.selected = true; break; }
      }

      const renderSkeleton = () => {
        clientesTbody.innerHTML = `
          <tr class="table-skeleton"><td colspan="5"></td></tr>
          <tr class="table-skeleton"><td colspan="5"></td></tr>
          <tr class="table-skeleton"><td colspan="5"></td></tr>
        `;
      };

      const montarPaginacao = (total, page, limit) => {
        paginacao.innerHTML = "";
        pageInfo.textContent = total > 0
          ? `PÃ¡gina ${page} • ${Math.min(total, page*limit) - limit + 1}â€“${Math.min(total, page*limit)} de ${total}`
          : "â€”";
        if (!total) return;
        const totalPages = Math.max(1, Math.ceil(total / limit));
        if (totalPages <= 1) return;

        const addItem = (label, p, disabled=false, active=false) => {
          const li = document.createElement("li");
          li.className = `page-item ${disabled ? "disabled" : ""} ${active ? "active" : ""}`;
          li.innerHTML = `<button class="page-link" data-page="${p}">${escapeHTML(label)}</button>`;
          paginacao.appendChild(li);
        };

        addItem("Anterior", Math.max(1, page - 1), page === 1, false);
        const start = Math.max(1, page - 3);
        const end = Math.min(totalPages, page + 3);
        for (let p = start; p <= end; p++) addItem(String(p), p, false, p === page);
        addItem("PrÃ³ximo", Math.min(totalPages, page + 1), page === totalPages, false);
      };

      const carregarClientes = async (page = 1) => {
        renderSkeleton();
        try {
          const data = await fetchJSON(API.clientes(page, limit), {}, 60000);
          const clientes = data.clientes || [];
          const total = Number(data.total || 0);
          currentPage = Number(data.page || page);

          if (!clientes.length) {
            clientesTbody.innerHTML = `<tr><td colspan="5" class="text-center">Nenhum cliente encontrado.</td></tr>`;
          } else {
            clientesTbody.innerHTML = clientes.map(c => `
              <tr>
                <td>${escapeHTML(c.CONTRATO ?? "-")}</td>
                <td>${escapeHTML(c.MATRICULA ?? "-")}</td>
                <td>${escapeHTML(c.COMPETENCIA_PAGAMENTO ?? "-")}</td>
                <td>${escapeHTML(c.BENEFICIARIO ?? "-")}</td>
                <td>${formatCurrencyBRL(c.VALOR)}</td>
              </tr>
            `).join("");
          }
          montarPaginacao(total, currentPage, limit);
        } catch (err) {
          console.error(err);
          showMessage((err && err.message) || "Erro ao carregar clientes.", "danger");
          clientesTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados.</td></tr>`;
        }
      };

      paginacao.addEventListener("click", (e) => {
        const btn = e.target.closest("button.page-link");
        if (!btn) return;
        const p = Number(btn.dataset.page || 1);
        carregarClientes(p);
      });

      limitSelect.addEventListener("change", () => {
        limit = Math.max(1, Number(limitSelect.value || 10));
        localStorage.setItem("clientes.limit", String(limit));
        carregarClientes(1);
      });

      // ------------------ Novo Cadastro (Matrícula) ------------------
      const matriculaModalEl = document.getElementById("matriculaModal");
      const clienteModalEl = document.getElementById("clienteModal");
      const matriculaForm = document.getElementById("matriculaForm");
      const matriculaInput = document.getElementById("matriculaInput");
      const clienteForm = document.getElementById("clienteForm");
      const salvarBtn = document.getElementById("salvarBtn");
      const matriculaLoading = document.getElementById("matriculaLoading");

      document.getElementById("logoutBtn").addEventListener("click", () => window.location.href = "/logout");

      // <<< CORREÃ‡ÃƒO AQUI: apenas atribuÃ­mos Ã s variÃ¡veis jÃ¡ declaradas >>>
      matriculaModal = new bootstrap.Modal(matriculaModalEl);
      clienteModal   = new bootstrap.Modal(clienteModalEl);

      document.getElementById("novoCadastroBtn").addEventListener("click", () => {
        matriculaForm.reset();
        matriculaLoading.classList.add("visually-hidden");
        matriculaModal.show();
      });

      const valueOr = (v, fallback) => (v === undefined || v === null || v === "" ? fallback : v);

      function applyBusinessRulesFromRules(raw) {
        const out = { ...raw };

        Object.entries(RULES).forEach(([field, rule]) => {
          if (rule.mode === "auto") {
            const fromApi = rule.defaultFrom ? raw[rule.defaultFrom] : undefined;
            const val = fromApi ?? (typeof rule.default === "function" ? rule.default() : rule.default);
            out[field] = val;
          }
          if (rule.mode === "select") {
            const def = typeof rule.default === "function" ? rule.default() : rule.default;
            out[field] = valueOr(raw[field], def);
          }
        });

        ["DATPROCESSAMENTO","DATA_EXECUCAO"].forEach(k=>{
          if (out[k]) out[k] = String(out[k]).split("T")[0];
        });

        ["VALOR","SEQ","VAL_FAT","FAT_NRO","UNI_COD_RESPON","IDADE","QTDE","SEQUENCIA"].forEach(k=>{
          if (out[k] !== undefined && out[k] !== null && out[k] !== "") {
            const n = Number(String(out[k]).replace(",", "."));
            if (!Number.isNaN(n)) out[k] = n;
          }
        });

        out["SEQ"] = 1;
        return out;
      }

      const montarFormulario = (dados = {}) => {
        clienteForm.innerHTML = "";
        formDirty = false;

        const base = applyBusinessRulesFromRules(dados);

        CAMPOS.forEach((campo) => {
          const rule = RULES[campo.id] || { mode: "user" };
          const isRequired = CAMPOS_OBRIGATORIOS_USER.includes(campo.id) && !rule.optional;
          const readOnly = rule.mode === "auto";
          const val = base[campo.id] ?? "";
          const requiredStar = isRequired ? `<span class="required-star">*</span>` : "";
          const stepAttr = campo.type === "number" ? `step="${campo.step || '1'}"` : "";

          let control = "";
          if (campo.type === "select" && rule.options) {
